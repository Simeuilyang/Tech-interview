# 뮤텍스와 세마포

*화장실 예제* : 공중 화장실은 한 번에 1명만 사용할 수 있다고 가정. 화장실에는 열쇠가 있다. 열쇠를 가지고 있는 한 사람만 화장실을 이용하고 열쇠가 없는 사람은 밖에서 대기를 한다.
## 뮤텍스(Mutex)
두 처리 단위(프로세스 or 스레드)가 임계 구역에 동시에 접근하지 못하도록 막는 기법이다.
+ 한 프로세스(스레드)가 소유하는 어떤 오브젝트를 기반으로 한 상호배제 기법
+ Mutual exclusion을 줄여 뮤텍스라 한다.
+ 뮤텍스는 객체 자체를 동시에 사용할 수 없다.
+ 위의 예제를 예로 들면 화장실 공간이 1개 이므로 열쇠는 1개이다. 뮤텍스는 열쇠라고 할 수 있다.
![image](https://user-images.githubusercontent.com/33089715/117651568-0c6fd600-b1cd-11eb-9685-cba0daeb54b2.png)
### 구현
```cpp
mutex = 1;

void lock () {
	while (mutex != 1) 
    {
        // mutex 값이 1이 될 때까지 대기
    }
    // 이 구역에 도착했다는 것은 화장실 키를 획득 했다는 것이고 mutex 값이 1이라는 뜻. 이제 뮤텍스 값을 0으로 만들어 다른 프로세스(혹은 쓰레드)의 접근을 제한.
    mutex = 0;
}

void unlock() {
	// 임계 구역(화장실)에서 나온 프로세스는 다른 프로세스가 접근할 개수 있도록 뮤텍스 값을 1으로 만들어 락을 해제.
	mutex = 1;
}

...
lock()
//critical section
unlock()
...

```

## 세마포(Semaphore)
세마포는 공유된 자원의 데이터를 여러 스레드, 또는 프로세스가 접근하는 것을 막는 기능을 한다.
+ 현재 공유 자원에 접근할 수 있는 프로세스(스레드)의 개수를 나내는 카운팅 변수값을 두는 방식의 상호 배제 기법
+ 여러 개의 공유 자원의 동기화를 맞추는 것을 목적으로 한다.
    + 예를 들어 서버의 프린트가 5개 있는 경우 세마포 값을 5로 설정하여 하나씩 점유할 때마다 1씩 감소하게 된다.)
+ 위의 예제를 예로 들면 화장실 공간이 4개이고 열쇠 또한 4개이다. 4명 까지는 대기 없이 바로 사용할 수 있고 그 다음 부터는 대기 해야 한다.
    + 빈 칸이 1개 이상이라면 열쇠의 개수를 하나 뺀 다음 화장실로 입장한다. 나올 때 열쇠의 개수를 하나 더해준다.
![image](https://user-images.githubusercontent.com/33089715/117651413-e0545500-b1cc-11eb-8347-5082040f75da.png)

### 구현
```cpp
struct semaphore {
	int count;
    queueType queue;
};

void semWait (semaphore s) {
	s.count--;
    if (s.count < 0) 
    {
    	// 이 구역으로 들어왔다는 것은 현재 프로세스(스레드)가 공유 자원에 접근할 수 없다는 것을 의미.
    	// 요청한 프로세스를 s.queue에 연결
        // 요청한 프로세스를 블록 상태로 락
    }
} 

void semSignal (semaphore s) {
	s.count++;
    if (s.count >= 0) 
    {
    	// 대기하고 있는 프로세스(스레드)를 위해 s.queue에 연결되어 있는 프로세스를 큐에서 제거
        // 프로세스의 상태를 실행 가능으로 변경하고 ready list에 연결
    }
}

...
semWait(S)
//critical section
//크리티컬 섹션의 길이가 길 때 사용하면 좋다.
//크리티컬 섹션의 길이가 긴데 busy wait 를 하면 이 때 메모리의 낭비가 많아짐
semSignal(S)
...

```
- semWait() 연산: 세마포어 값을 감소시킨다. 만일 값이 음수가 되면 semWait를 호출한 프로세스는 블록(락) 된다. 즉, 음수가 아니면, 프로세스는 계속 수행될 수 있다.
- semSignal() 연산: 세마포어 값을 증가시킨다. 만약 값이 양수이면, semWait 연산에 의해 블록된 프로세스들을 해제한다.

## 뮤텍스와 세마포의 차이
- Mutex는 상태가 0, 1 두 개 뿐인 binary Semaphore 라고 볼 수 있다.

- 대상의 개수
    - 뮤텍스 : 동기화 대상이 하나
    - 세마포 : 동기화 대상이 하나 이상일 때
- 해제 대상
    - 뮤텍스 : 뮤텍스를 소유하고 있는 스레드만이 뮤텍스를 해제할 수 있다.
    - 세마포 : 세마포 객체를 공유하기 때문에 다른 스레드가 세마포를 해제할 수 있다.

- Semaphore는 시스템 범위에 걸쳐있고 파일 시스템 상의 파일 형태로 존재한다. 반면 Mutex는 프로세스 범위를 가지며 프로세스가 종료될 때 자동으로 해제된다.


---
### 출처
https://velog.io/@hidaehyunlee/Philosophers-%EC%98%88%EC%8B%9C%EC%98%88%EC%A0%9C%EB%A1%9C-%EB%B3%B4%EB%8A%94-%EB%AE%A4%ED%85%8D%EC%8A%A4%EC%99%80-%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4%EC%9D%98-%EC%B0%A8%EC%9D%B4